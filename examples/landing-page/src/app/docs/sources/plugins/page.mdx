# Plugins

Extend zonfig with custom configuration sources like AWS Secrets Manager, HashiCorp Vault, and more.

## Using Plugins

```typescript
const config = await defineConfig({
  schema,
  sources: [
    { type: 'file', path: './config/default.json' },
    { type: 'plugin', name: 'aws-secrets', options: { secretId: 'prod/myapp' } },
    { type: 'env', prefix: 'APP_' },
  ],
});
```

## Creating a Plugin

Use `definePlugin` to create a custom source:

```typescript
import { definePlugin, registerPlugin } from '@zonfig/zonfig';

const myPlugin = definePlugin({
  name: 'my-plugin',
  async load(options, context) {
    // Fetch configuration from your source
    const data = await fetchFromMySource(options);
    return data;
  },
});

// Register globally
registerPlugin(myPlugin);
```

## Plugin Interface

```typescript
interface DefinePluginOptions<T> {
  name: string;
  load: (options: T, context: LoaderContext) => Promise<Record<string, unknown>>;
  validate?: (options: T) => boolean | string;
}

interface LoaderContext {
  profile?: string;
  cwd: string;
}
```

## AWS Secrets Manager Example

```typescript
import { SecretsManagerClient, GetSecretValueCommand } from '@aws-sdk/client-secrets-manager';
import { definePlugin, registerPlugin } from '@zonfig/zonfig';

interface AwsSecretsOptions {
  secretId: string;
  region?: string;
}

const awsSecretsPlugin = definePlugin<AwsSecretsOptions>({
  name: 'aws-secrets',

  validate(options) {
    if (!options.secretId) {
      return 'secretId is required';
    }
    return true;
  },

  async load(options, context) {
    const client = new SecretsManagerClient({
      region: options.region ?? 'us-east-1',
    });

    const response = await client.send(
      new GetSecretValueCommand({ SecretId: options.secretId })
    );

    return JSON.parse(response.SecretString ?? '{}');
  },
});

registerPlugin(awsSecretsPlugin);
```

## HashiCorp Vault Example

```typescript
import { definePlugin, registerPlugin } from '@zonfig/zonfig';

interface VaultOptions {
  address: string;
  path: string;
  token?: string;
}

const vaultPlugin = definePlugin<VaultOptions>({
  name: 'vault',

  async load(options) {
    const token = options.token ?? process.env.VAULT_TOKEN;

    const response = await fetch(`${options.address}/v1/${options.path}`, {
      headers: { 'X-Vault-Token': token! },
    });

    const data = await response.json();
    return data.data.data;
  },
});

registerPlugin(vaultPlugin);
```

## Using Multiple Plugins

```typescript
sources: [
  { type: 'file', path: './config/default.json' },
  { type: 'plugin', name: 'vault', options: { address: 'https://vault.example.com', path: 'secret/data/myapp' } },
  { type: 'plugin', name: 'aws-secrets', options: { secretId: 'myapp/api-keys' } },
  { type: 'env', prefix: 'APP_' },
]
```

## Plugin Management

```typescript
import {
  registerPlugin,
  getPlugin,
  hasPlugin,
  unregisterPlugin,
  clearPlugins,
} from '@zonfig/zonfig';

// Check if plugin exists
if (hasPlugin('aws-secrets')) {
  // Get plugin instance
  const plugin = getPlugin('aws-secrets');
}

// Remove a plugin
unregisterPlugin('aws-secrets');

// Remove all plugins
clearPlugins();
```

## Error Handling

Plugins should throw descriptive errors:

```typescript
const myPlugin = definePlugin({
  name: 'my-plugin',
  async load(options) {
    try {
      return await fetchData(options);
    } catch (error) {
      throw new Error(`Failed to load config from my-plugin: ${error.message}`);
    }
  },
});
```

## Profile-Aware Plugins

Use the context to load profile-specific config:

```typescript
const myPlugin = definePlugin({
  name: 'my-plugin',
  async load(options, context) {
    const path = context.profile
      ? `config/${context.profile}`
      : 'config/default';

    return await fetchFromPath(path);
  },
});
```

## Next Steps

- [Configuration Sources](/docs/sources) - Overview of all sources
- [Secret Management](/docs/guides/secrets) - Best practices for secrets
